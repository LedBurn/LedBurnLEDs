import pygame
import random

from Simulator.SheepSimulator import SheepSimulator

from UIElements.BigSheep12 import BigSheep12
from UIElements.BigSheep34 import BigSheep34
from UIElements.SmallSheep import SmallSheep
from UIElements.Signs import Signs

from Animations.AfterPeakAnimations import *
from Animations.PeakAnimations import *

pygame.init()
clock = pygame.time.Clock()

# simulator
smallSheep = SmallSheep()
bigSheep12 = BigSheep12()
bigSheep34 = BigSheep34()
signs = Signs()
simulator = SheepSimulator()

# audio
FILE_NAME = "ChristmasDubstep"
INPUT_FILE = "Music_Samples/" + FILE_NAME + ".mp3"
beat_times = [0.0, 0.185759637188, 0.928798185941, 1.76471655329, 2.62385487528, 3.48299319728, 4.34213151927, 5.20126984127, 6.06040816327, 6.89632653061, 7.75546485261, 8.6146031746, 9.4737414966, 10.3328798186, 11.1687981859, 12.0511564626, 12.9102947846, 13.7694331066, 14.6053514739, 15.4644897959, 16.3236281179, 17.1827664399, 18.0419047619, 18.9010430839, 19.7601814059, 20.6193197279, 21.4784580499, 22.3375963719, 23.1967346939, 24.0558730159, 24.8917913832, 25.7509297052, 26.6100680272, 27.4692063492, 28.3283446712, 29.1874829932, 30.0466213152, 30.9057596372, 31.7648979592, 32.6240362812, 33.4831746032, 34.3423129252, 35.1782312925, 36.0373696145, 36.8965079365, 37.7556462585, 38.6147845805, 39.4739229025, 40.3330612245, 41.1921995465, 42.0513378685, 42.9104761905, 43.7696145125, 44.6287528345, 45.4878911565, 46.3470294785, 47.2061678005, 48.0653061224, 48.9244444444, 49.8068027211, 50.6659410431, 51.4786394558, 52.3377777778, 53.1969160998, 54.0560544218, 54.8223129252, 55.7511111111, 56.6102494331, 57.4693877551, 58.3285260771, 59.1876643991, 60.0468027211, 60.9059410431, 61.6721995465, 62.6242176871, 63.4833560091, 64.3424943311, 65.2016326531, 66.0607709751, 66.9199092971, 67.779047619, 68.638185941, 69.4741043084, 70.3332426304, 71.1923809524, 72.0515192744, 72.9106575964, 73.7697959184, 74.6289342404, 75.4880725624, 76.3472108844, 77.2063492063, 78.0422675737, 78.9246258503, 79.7837641723, 80.6429024943, 81.5020408163, 82.3611791383, 83.2203174603, 84.0794557823, 84.9153741497, 85.751292517, 86.610430839, 87.469569161, 88.328707483, 89.187845805, 90.046984127, 90.906122449, 91.765260771, 92.624399093, 93.4603174603, 94.342675737, 95.201814059, 96.060952381, 96.8968707483, 97.7560090703, 98.6151473923, 99.4742857143, 100.333424036, 101.192562358, 102.05170068, 102.910839002, 103.769977324, 104.629115646, 105.488253968, 106.324172336, 107.183310658, 108.04244898, 108.901587302, 109.760725624, 110.619863946, 111.479002268, 112.33814059, 113.197278912, 114.033197279, 114.915555556, 115.774693878, 116.6338322, 117.469750567, 118.328888889, 119.188027211, 120.047165533, 120.906303855, 121.765442177, 122.624580499, 123.506938776, 124.366077098, 125.22521542, 126.084353741, 126.920272109, 127.756190476, 128.615328798, 129.47446712, 130.333605442, 131.192743764, 132.051882086, 132.911020408, 133.77015873, 134.629297052, 135.488435374, 136.347573696, 137.1138322, 138.042630385, 138.901768707, 139.760907029, 140.620045351, 141.479183673, 142.338321995, 143.197460317, 144.056598639, 144.915736961, 145.774875283, 146.610793651, 147.493151927, 148.329070295, 149.188208617, 150.047346939, 150.906485261, 151.765623583, 152.624761905, 153.483900227]
onset_times = [0.0, 0.116099773243, 0.232199546485, 0.325079365079, 0.510839002268, 0.719818594104, 0.95201814059, 1.16099773243, 1.39319727891, 1.60217687075, 1.81115646259, 1.95047619048, 2.04335600907, 2.22911564626, 2.4380952381, 2.67029478458, 2.80961451247, 2.87927437642, 3.1114739229, 3.29723356009, 3.52943310658, 3.66875283447, 3.94739229025, 4.15637188209, 4.36535147392, 4.52789115646, 4.59755102041, 4.7368707483, 4.80653061224, 5.01551020408, 5.22448979592, 5.38702947846, 5.66566893424, 5.87464852608, 6.08362811791, 6.24616780045, 6.3158276644, 6.52480725624, 6.73378684807, 6.94276643991, 7.0820861678, 7.17496598639, 7.38394557823, 7.59292517007, 7.77868480726, 8.03410430839, 8.24308390023, 8.45206349206, 8.6610430839, 8.80036281179, 8.89324263039, 9.10222222222, 9.28798185941, 9.40408163265, 9.5201814059, 9.75238095238, 9.96136054422, 10.1703401361, 10.3793197279, 10.5186394558, 10.6115192744, 10.8204988662, 11.0062585034, 11.2152380952, 11.4706575964, 11.6796371882, 11.8653968254, 12.0743764172, 12.2369160998, 12.3297959184, 12.5155555556, 12.7245351474, 12.8406349206, 12.9567346939, 13.3979138322, 13.4907936508, 13.5836734694, 13.7926530612, 13.9551927438, 14.2338321995, 14.4428117914, 14.6517913832, 14.8839909297, 15.0929705215, 15.3019501134, 15.5109297052, 15.6734693878, 15.7431292517, 15.9521088435, 16.1610884354, 16.2771882086, 16.3700680272, 16.6022675737, 16.8344671202, 17.0202267574, 17.2292063492, 17.3685260771, 17.4614058957, 17.6703854875, 17.8793650794, 18.0883446712, 18.3205442177, 18.5295238095, 18.7385034014, 18.9474829932, 19.0868027211, 19.1796825397, 19.3886621315, 19.5744217687, 19.7137414966, 19.8066213152, 20.0388208617, 20.2710204082, 20.4567800454, 20.6657596372, 20.8050793651, 20.8979591837, 21.1069387755, 21.2926984127, 21.5016780045, 21.9660770975, 22.1750566893, 22.3840362812, 22.5233560091, 22.6162358277, 22.8019954649, 23.0109750567, 23.1270748299, 23.2199546485, 23.6843537415, 23.8701133787, 24.0790929705, 24.2416326531, 24.311292517, 24.5202721088, 24.7292517007, 24.9382312925, 25.170430839, 25.3794104308, 25.5883900227, 25.7973696145, 25.9599092971, 26.029569161, 26.2385487528, 26.4475283447, 26.5636281179, 26.6565079365, 26.888707483, 27.1209070295, 27.3066666667, 27.5156462585, 27.747845805, 27.9568253968, 28.1658049887, 28.3747845805, 28.8159637188, 29.2339229025, 29.466122449, 29.6751020408, 29.8840816327, 30.0001814059, 30.0930612245, 30.5342403628, 30.7432199546, 30.9521995465, 31.0915192744, 31.3933786848, 31.579138322, 31.7184580499, 31.8113378685, 32.2525170068, 32.4614965986, 32.6704761905, 32.8097959184, 32.902675737, 33.0884353741, 33.297414966, 33.4135147392, 33.5063945578, 33.9707936508, 34.156553288, 34.3655328798, 34.5280725624, 34.5977324263, 34.8067120181, 35.01569161, 35.1550113379, 35.2246712018, 35.4568707483, 35.6658503401, 35.874829932, 36.0838095238, 36.2231292517, 36.5249886621, 36.66430839, 36.733968254, 36.8500680272, 36.9429478458, 37.4073469388, 37.5002267574, 37.593106576, 37.8020861678, 37.9646258503, 38.0342857143, 38.2432653061, 38.4290249433, 38.6612244898, 38.8934240363, 39.1024036281, 39.31138322, 39.5203628118, 39.6596825397, 39.7525623583, 39.9615419501, 40.1473015873, 40.2634013605, 40.3795011338, 40.6117006803, 40.8206802721, 41.0296598639, 41.2386394558, 41.3779591837, 41.6565986395, 41.8655782313, 42.0745578231, 42.3299773243, 42.5389569161, 42.7479365079, 42.9336961451, 43.1891156463, 43.3748752834, 43.6070748299, 43.7928344671, 44.0250340136, 44.2340136054, 44.6751927438, 44.8841723356, 45.0931519274, 45.3021315193, 45.5111111111, 45.7433106576, 45.9522902494, 46.3934693878, 46.6024489796, 46.8114285714, 47.0204081633, 47.2293877551, 47.4615873016, 47.6705668934, 48.1117460317, 48.5297052154, 48.9476643991, 49.3888435374, 49.8300226757, 50.2479818594, 50.6891609977, 51.5250793651, 51.7572789116, 51.9662585034, 52.1520181406, 52.3609977324, 52.8253968254, 53.0111564626, 53.2433560091, 53.4523356009, 53.6613151927, 53.8702947846, 53.9863945578, 54.1024943311, 54.5436734694, 54.7294331066, 54.8455328798, 54.9616326531, 55.1706122449, 55.3795918367, 55.5885714286, 55.7975510204, 56.0529705215, 56.2387301587, 56.6566893424, 56.8192290249, 56.9817687075, 57.1210884354, 57.3068480726, 57.4229478458, 57.5158276644, 57.8873469388, 58.3749659864, 58.6071655329, 58.8161451247, 59.0251247166, 59.2341043084, 59.6752834467, 59.8842630385, 60.0932426304, 60.3254421769, 60.5344217687, 60.7434013605, 60.8595011338, 60.9523809524, 61.3935600907, 61.6025396825, 61.7186394558, 61.8115192744, 62.0204988662, 62.229478458, 62.4616780045, 62.6474376417, 62.9028571429, 63.3208163265, 63.5065759637, 63.6691156463, 63.8548752834, 63.9709750567, 64.1567346939, 64.3889342404, 65.2248526077, 65.6892517007, 65.8982312925, 66.0839909297, 66.3161904762, 66.525170068, 66.7341496599, 66.8502494331, 66.9431292517, 67.1753287982, 67.38430839, 67.5932879819, 67.7093877551, 67.8022675737, 68.0344671202, 68.243446712, 68.4524263039, 68.5685260771, 68.6614058957, 68.8936054422, 69.102585034, 69.3115646259, 69.4276643991, 69.5205442177, 69.7527437642, 69.961723356, 70.1707029478, 70.3796825397, 70.6118820862, 70.820861678, 71.0298412698, 71.1459410431, 71.2388208617, 71.4710204082, 71.68, 71.8889795918, 71.9818594104, 72.0979591837, 72.539138322, 72.7481179138, 72.8642176871, 72.9570975057, 73.398276644, 73.6072562358, 73.7233560091, 73.8162358277, 74.0252154195, 74.257414966, 74.4663945578, 74.5592743764, 74.6753741497, 75.116553288, 75.3023129252, 75.4184126984, 75.5345124717, 75.7434920635, 75.97569161, 76.1846712018, 76.3007709751, 76.370430839, 76.6026303855, 76.8116099773, 77.0438095238, 77.229569161, 77.3921088435, 77.4617687075, 77.6707482993, 77.8797278912, 77.9958276644, 78.088707483, 78.3209070295, 78.5298866213, 78.6459863946, 78.7388662132, 78.8549659864, 78.9710657596, 79.8302040816, 80.2481632653, 82.384399093, 82.8255782313, 83.2667573696, 83.7079365079, 84.5438548753, 84.961814059, 85.3797732426, 85.7977324263, 85.9370521542, 86.0299319728, 86.2389115646, 86.4478911565, 86.6568707483, 86.8890702948, 87.0980498866, 87.3070294785, 87.5160090703, 87.6553287982, 87.7482086168, 87.9571882086, 88.1429478458, 88.2822675737, 88.3751473923, 88.6073469388, 88.723446712, 88.9324263039, 89.0253061224, 89.2342857143, 89.3736054422, 89.4664852608, 89.652244898, 89.8612244898, 90.0702040816, 90.3256235828, 90.441723356, 90.5346031746, 90.7435827664, 90.9525623583, 91.0918820862, 91.1847619048, 91.370521542, 91.5795011338, 91.695600907, 91.8117006803, 92.0439002268, 92.16, 92.2528798186, 92.4618594104, 92.6476190476, 92.8101587302, 93.0887981859, 93.2977777778, 93.5067573696, 93.7389569161, 93.878276644, 93.9711564626, 94.1569160998, 94.3658956916, 94.5284353741, 94.5980952381, 94.8070748299, 95.0160544218, 95.132154195, 95.2250340136, 95.4572335601, 95.596553288, 95.6894331066, 95.7823129252, 95.8751927438, 96.0841723356, 96.2467120181, 96.3163718821, 96.5253514739, 96.7343310658, 96.9433106576, 97.1755102041, 97.3844897959, 97.5934693878, 97.8024489796, 97.9417687075, 98.0346485261, 98.2436281179, 98.4293877551, 98.568707483, 98.6615873016, 98.8937868481, 99.033106576, 99.3117460317, 99.5207256236, 99.6600453515, 99.7529251701, 99.9386848073, 100.147664399, 100.356643991, 100.612063492, 100.821043084, 101.030022676, 101.239002268, 101.378321995, 101.471201814, 101.656961451, 101.865941043, 101.982040816, 102.09814059, 102.330340136, 102.446439909, 102.539319728, 102.74829932, 102.934058957, 103.096598639, 103.375238095, 103.584217687, 103.793197279, 104.234376417, 104.652335601, 104.814875283, 104.884535147, 105.023854875, 105.116734694, 105.302494331, 105.418594104, 105.511473923, 105.882993197, 105.975873016, 106.370612245, 106.533151927, 106.602811791, 106.811791383, 107.020770975, 107.160090703, 107.229750567, 107.461950113, 107.670929705, 107.879909297, 108.088888889, 108.228208617, 108.321088435, 108.530068027, 108.715827664, 108.855147392, 108.948027211, 109.319546485, 109.389206349, 109.598185941, 109.807165533, 109.946485261, 110.039365079, 110.248344671, 110.434104308, 110.573424036, 110.666303855, 111.107482993, 111.316462585, 111.525442177, 111.664761905, 111.943401361, 112.082721088, 112.175600907, 112.384580499, 112.825759637, 113.034739229, 113.220498866, 113.383038549, 113.661678005, 113.870657596, 114.079637188, 114.311836735, 114.520816327, 114.729795918, 114.93877551, 115.101315193, 115.379954649, 115.58893424, 115.705034014, 115.797913832, 116.030113379, 116.169433107, 116.448072562, 116.657052154, 116.819591837, 116.889251701, 117.098231293, 117.307210884, 117.516190476, 117.748390023, 117.957369615, 118.166349206, 118.375328798, 118.607528345, 118.793287982, 119.025487528, 119.23446712, 119.466666667, 119.58276644, 119.675646259, 120.093605442, 120.325804989, 120.511564626, 120.743764172, 120.952743764, 121.184943311, 121.370702948, 121.811882086, 122.044081633, 122.22984127, 122.462040816, 122.671020408, 122.88, 123.019319728, 123.112199546, 123.553378685, 123.948117914, 124.389297052, 124.807256236, 125.271655329, 125.689614512, 126.130793651, 126.316553288, 126.943492063, 127.17569161, 127.384671202, 127.593650794, 127.802630385, 128.243809524, 128.452789116, 128.661768707, 128.893968254, 129.102947846, 129.311927438, 129.428027211, 129.520907029, 129.962086168, 130.17106576, 130.287165533, 130.589024943, 130.798004535, 131.030204082, 131.215963719, 131.47138322, 131.889342404, 132.098321995, 132.284081633, 132.400181406, 132.539501134, 132.725260771, 132.934240363, 133.375419501, 133.816598639, 134.025578231, 134.234557823, 134.443537415, 134.652517007, 135.093696145, 135.302675737, 135.511655329, 135.743854875, 135.952834467, 136.161814059, 136.277913832, 136.394013605, 136.811972789, 137.020952381, 137.137052154, 137.253151927, 137.462131519, 137.671111111, 137.880090703, 138.089070295, 138.321269841, 138.739229025, 138.948208617, 139.133968254, 139.296507937, 139.389387755, 139.598367347, 139.71446712, 139.807346939, 140.248526077, 140.666485261, 141.107664399, 141.316643991, 141.525623583, 141.966802721, 142.175782313, 142.291882086, 142.384761905, 142.593741497, 142.825941043, 143.034920635, 143.127800454, 143.243900227, 143.476099773, 143.685079365, 143.894058957, 143.986938776, 144.103038549, 144.544217687, 144.729977324, 144.846077098, 144.938956916, 145.171156463, 145.380136054, 145.612335601, 145.821315193, 146.030294785, 146.239274376, 146.448253968, 146.564353741, 146.65723356, 146.889433107, 147.098412698, 147.214512472, 147.30739229, 147.423492063, 147.516371882, 147.95755102, 148.166530612, 148.282630385, 148.375510204, 148.607709751, 148.816689342, 148.932789116, 149.025668934, 149.141768707, 149.234648526, 149.675827664, 149.884807256, 150.000907029, 150.093786848, 150.325986395, 150.534965986, 150.743945578, 150.860045351, 150.95292517, 151.394104308, 151.6030839, 151.719183673, 151.812063492, 151.928163265, 152.044263039, 152.25324263, 152.462222222, 152.671201814, 152.880181406, 152.996281179, 153.089160998, 153.29814059, 153.414240363, 153.530340136, 153.762539683, 153.94829932, 154.064399093, 154.180498866, 154.273378685, 154.389478458, 156.107755102, 156.966893424, 157.826031746, 158.685170068]

current_onset = 0
current_beat = 0

# play music
pygame.mixer.init()
pygame.mixer.music.load(INPUT_FILE)
pygame.mixer.music.play(0, 0)

# animations
MAX_BRIGTHNESS = 1.0
onset_animations = [PeakAnimation_Core_IncreaseHue(smallSheep.get_body_indexes(), MAX_BRIGTHNESS, 0.1, 0.12)]
beat_animations = [PeakAnimation_Core_IncreaseHue(smallSheep.get_head_indexes() + smallSheep.get_legs_indexes(), MAX_BRIGTHNESS, 0.4, 0.08),
                   AfterPeakAnimation_AddOn_BrightnessLoss(smallSheep.get_head_indexes() + smallSheep.get_legs_indexes(), 1.0)]


def apply_animations(song_time):
    global current_onset
    global current_beat
    new_onset = False
    new_beat = False

    # increas current onset
    while (song_time >= onset_times[current_onset] and current_onset < len(onset_times)):
        current_onset += 1
        new_onset = True
    time_since_last_onset = song_time - onset_times[current_onset - 1]

    # increas current beat
    while (song_time >= beat_times[current_beat] and current_beat < len(beat_times)):
        current_beat += 1
        new_beat = True
    time_since_last_beat = song_time - beat_times[current_beat - 1]

    # run animations
    print ("apply_animations")
    
    for onset_animation in onset_animations:
        if (isinstance(onset_animation, PeakAnimation)):
            onset_animation.apply(new_onset, smallSheep.get_array())
            print (new_onset)
        if (isinstance(onset_animation, AfterPeakAnimation)):
            onset_animation.apply(time_since_last_onset, smallSheep.get_array())
   
    for beat_animation in beat_animations:
        if (isinstance(beat_animation, PeakAnimation)):
            beat_animation.apply(new_beat, smallSheep.get_array())
        if (isinstance(beat_animation, AfterPeakAnimation)):
            beat_animation.apply(time_since_last_beat, smallSheep.get_array())


# MAIN #

while pygame.mixer.music.get_busy():
        song_time = pygame.mixer.music.get_pos()
        song_time = song_time / 1000.0
        
        # run anumation
        apply_animations(song_time)

        # send data to LEDs
        simulator.draw_LEDs(smallSheep.get_array(),
                            bigSheep12.get_array(),
                            bigSheep34.get_array(),
                            signs.get_array())

        clock.tick(50)

        for event in pygame.event.get():  # user did something
            if event.type == pygame.QUIT:
                done = True



